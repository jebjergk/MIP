# Timestamp audit report (Berlin NTZ standard)

This report lists every object changed to enforce Berlin-local `TIMESTAMP_NTZ` persistence via `MIP.APP.F_NOW_BERLIN_NTZ()`.

## Helper UDF
- **Function:** `MIP.APP.F_NOW_BERLIN_NTZ()`
  - **Before:** _N/A (new)_
  - **After:**
    ```sql
    create or replace function MIP.APP.F_NOW_BERLIN_NTZ()
    returns timestamp_ntz
    as
    $$
        convert_timezone('UTC', 'Europe/Berlin', current_timestamp())::timestamp_ntz
    $$;
    ```

## Tables (defaults)
- **MIP.APP.APP_CONFIG.UPDATED_AT**
  - **Before:** `UPDATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `UPDATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.BACKTEST_RUN.CREATED_AT** (from `020_app_backtest_tables.sql`)
  - **Before:** `CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP`
  - **After:** `CREATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.INGEST_UNIVERSE.CREATED_AT**
  - **Before:** `CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `CREATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.PATTERN_DEFINITION.CREATED_AT**
  - **Before:** `CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `CREATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.RECOMMENDATION_LOG.GENERATED_AT**
  - **Before:** `GENERATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `GENERATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.RECOMMENDATION_OUTCOMES.CALCULATED_AT**
  - **Before:** `CALCULATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `CALCULATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.OUTCOME_EVALUATION.EVALUATED_AT**
  - **Before:** `EVALUATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `EVALUATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.BACKTEST_RUN.CREATED_AT** (from `050_app_core_tables.sql`)
  - **Before:** `CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `CREATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.MIP_AUDIT_LOG.EVENT_TS**
  - **Before:** `EVENT_TS TIMESTAMP_NTZ DEFAULT CONVERT_TIMEZONE('UTC','CET', CURRENT_TIMESTAMP())`
  - **After:** `EVENT_TS TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.PORTFOLIO_PROFILE.CREATED_AT**
  - **Before:** `CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `CREATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.PORTFOLIO.CREATED_AT / UPDATED_AT**
  - **Before:** `DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.PORTFOLIO_POSITIONS.CREATED_AT**
  - **Before:** `CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `CREATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.PORTFOLIO_TRADES.CREATED_AT**
  - **Before:** `CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `CREATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.PORTFOLIO_DAILY.CREATED_AT**
  - **Before:** `CREATED_AT TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `CREATED_AT TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.SIM_READINESS_AUDIT.AUDIT_TS**
  - **Before:** `AUDIT_TS TIMESTAMP_NTZ DEFAULT CURRENT_TIMESTAMP()`
  - **After:** `AUDIT_TS TIMESTAMP_NTZ DEFAULT MIP.APP.F_NOW_BERLIN_NTZ()`

## Procedures (persisted timestamps)
- **MIP.APP.SP_LOG_EVENT**
  - **Before:** `CONVERT_TIMEZONE('UTC','CET', CURRENT_TIMESTAMP())`
  - **After:** `MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.SP_EVALUATE_RECOMMENDATIONS**
  - **Before:** `CURRENT_TIMESTAMP()` for `v_to_ts`/`CALCULATED_AT`
  - **After:** `MIP.APP.F_NOW_BERLIN_NTZ()` for `v_to_ts`/`CALCULATED_AT`

- **MIP.APP.SP_RUN_BACKTEST**
  - **Before:** `UPDATED_AT = CURRENT_TIMESTAMP()`
  - **After:** `UPDATED_AT = MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.SP_TRAIN_PATTERNS_FROM_BACKTEST**
  - **Before:** `LAST_TRAINED_AT = CURRENT_TIMESTAMP()`
  - **After:** `LAST_TRAINED_AT = MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.SP_RUN_MIP_LEARNING_CYCLE**
  - **Before:** `v_to_ts := CURRENT_TIMESTAMP()` and `LOG_TS = CURRENT_TIMESTAMP()`
  - **After:** `v_to_ts := MIP.APP.F_NOW_BERLIN_NTZ()` and `LOG_TS = MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.SP_RUN_DAILY_TRAINING**
  - **Before:** `v_to_ts := CURRENT_TIMESTAMP()`
  - **After:** `v_to_ts := MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.SP_RUN_DAILY_PIPELINE**
  - **Before:** `CONVERT_TIMEZONE('UTC','CET', CURRENT_TIMESTAMP())` and `CURRENT_TIMESTAMP()`
  - **After:** `MIP.APP.F_NOW_BERLIN_NTZ()` for `EVENT_TS` and step timestamps

- **MIP.APP.SP_SIMULATE_PORTFOLIO**
  - **Before:** `EVENT_TS`, `LAST_SIMULATED_AT`, `UPDATED_AT` from `CURRENT_TIMESTAMP()`
  - **After:** `MIP.APP.F_NOW_BERLIN_NTZ()` for all persisted timestamps

- **MIP.APP.SP_SEED_MIP_DEMO**
  - **Before:** `UPDATED_AT`/`INGESTED_AT = CURRENT_TIMESTAMP()`
  - **After:** `UPDATED_AT`/`INGESTED_AT = MIP.APP.F_NOW_BERLIN_NTZ()`

- **MIP.APP.SP_VALIDATE_SIM_READINESS**
  - **Before:** `v_as_of_ts := CURRENT_TIMESTAMP()` and audit insert `CURRENT_TIMESTAMP()`
  - **After:** `v_as_of_ts := MIP.APP.F_NOW_BERLIN_NTZ()` and audit insert `MIP.APP.F_NOW_BERLIN_NTZ()`
