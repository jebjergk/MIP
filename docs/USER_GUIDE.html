<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIP User Guide</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--gray-800);
            background: var(--gray-50);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Navigation */
        nav {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        nav h2 {
            font-size: 1.1rem;
            color: var(--gray-600);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        nav ol {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        nav a {
            color: var(--primary);
            text-decoration: none;
            padding: 0.5rem;
            border-radius: 6px;
            display: block;
            transition: background 0.2s;
        }

        nav a:hover {
            background: var(--gray-100);
        }

        /* Sections */
        section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        h2 {
            font-size: 1.75rem;
            color: var(--gray-900);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary);
        }

        h3 {
            font-size: 1.35rem;
            color: var(--gray-800);
            margin: 1.5rem 0 1rem 0;
        }

        h4 {
            font-size: 1.1rem;
            color: var(--gray-700);
            margin: 1.25rem 0 0.75rem 0;
        }

        p {
            margin-bottom: 1rem;
            color: var(--gray-700);
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0 1.5rem 0;
            font-size: 0.95rem;
        }

        th {
            background: var(--gray-100);
            color: var(--gray-800);
            font-weight: 600;
            text-align: left;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid var(--gray-200);
        }

        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: top;
        }

        tr:hover {
            background: var(--gray-50);
        }

        /* Code and pre */
        code {
            background: var(--gray-100);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.9em;
            color: var(--primary-dark);
        }

        pre {
            background: var(--gray-800);
            color: #e5e7eb;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-safe { background: #d1fae5; color: #065f46; }
        .badge-caution { background: #fef3c7; color: #92400e; }
        .badge-stopped { background: #fee2e2; color: #991b1b; }
        .badge-trusted { background: #dbeafe; color: #1e40af; }
        .badge-watch { background: #fef3c7; color: #92400e; }
        .badge-untrusted { background: #f3f4f6; color: #4b5563; }

        /* Info boxes */
        .info-box {
            padding: 1rem 1.25rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .info-box.tip {
            background: #eff6ff;
            border-color: var(--primary);
        }

        .info-box.warning {
            background: #fffbeb;
            border-color: var(--warning);
        }

        .info-box.important {
            background: #fef2f2;
            border-color: var(--danger);
        }

        /* Flow diagram */
        .flow-diagram {
            background: var(--gray-100);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .flow-step {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
        }

        .flow-number {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .flow-arrow {
            color: var(--gray-400);
            margin-left: 0.5rem;
        }

        /* Cards */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1.25rem;
        }

        .card h5 {
            font-size: 1rem;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }

        .card p {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-bottom: 0;
        }

        /* Data flow visual */
        .data-flow {
            background: linear-gradient(180deg, var(--gray-50) 0%, white 100%);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .data-flow-item {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            text-align: center;
            margin: 0.5rem auto;
            max-width: 300px;
            font-weight: 500;
        }

        .data-flow-item.primary {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .data-flow-arrow {
            text-align: center;
            color: var(--gray-400);
            font-size: 1.5rem;
        }

        /* Screen cards */
        .screen-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .screen-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        /* Lists */
        ul, ol {
            margin: 0.5rem 0 1rem 1.5rem;
        }

        li {
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--gray-500);
            font-size: 0.9rem;
        }

        /* Print styles */
        @media print {
            body { background: white; }
            .container { max-width: 100%; }
            section { box-shadow: none; border: 1px solid var(--gray-200); }
            nav { page-break-after: always; }
            h2 { page-break-after: avoid; }
            table { page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<header>
    <h1>üìä MIP User Guide</h1>
    <p>Market Intelligence Platform ‚Äî Complete Reference Guide</p>
</header>

<div class="container">

<!-- Table of Contents -->
<nav>
    <h2>Table of Contents</h2>
    <ol>
        <li><a href="#introduction">1. Introduction</a></li>
        <li><a href="#screens">2. Understanding the Screens</a></li>
        <li><a href="#backend">3. How the Backend Works</a></li>
        <li><a href="#concepts">4. Key Concepts</a></li>
        <li><a href="#troubleshooting">5. Troubleshooting</a></li>
        <li><a href="#glossary">6. Glossary</a></li>
    </ol>
</nav>

<!-- Section 1: Introduction -->
<section id="introduction">
    <h2>1. Introduction</h2>
    
    <p>MIP (Market Intelligence Platform) is a paper trading system that automatically:</p>
    
    <div class="flow-diagram">
        <div class="flow-step"><span class="flow-number">1</span> Collects market data from financial APIs</div>
        <div class="flow-step"><span class="flow-number">2</span> Detects patterns in price movements</div>
        <div class="flow-step"><span class="flow-number">3</span> Generates trading signals based on those patterns</div>
        <div class="flow-step"><span class="flow-number">4</span> Evaluates signal quality over time</div>
        <div class="flow-step"><span class="flow-number">5</span> Simulates portfolios with risk management</div>
        <div class="flow-step"><span class="flow-number">6</span> Proposes and executes trades (paper trading)</div>
        <div class="flow-step"><span class="flow-number">7</span> Generates daily briefs summarizing opportunities</div>
    </div>

    <div class="info-box tip">
        <strong>When does it run?</strong> The system runs automatically every day at 07:00 (Europe/Berlin), but you can also trigger it manually anytime.
    </div>
</section>

<!-- Section 2: Screens -->
<section id="screens">
    <h2>2. Understanding the Screens</h2>

    <!-- Home -->
    <h3>üè† Home</h3>
    <p><strong>What it shows:</strong> A quick overview of the system status and shortcuts to common actions.</p>
    
    <table>
        <thead>
            <tr><th>Element</th><th>What it means</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Last Pipeline Run</strong></td><td>When the system last processed data. Shows time ago (e.g., "2 hours ago")</td></tr>
            <tr><td><strong>New Evaluations</strong></td><td>How many signals were evaluated since the last run</td></tr>
            <tr><td><strong>Latest Brief</strong></td><td>When the last morning brief was generated</td></tr>
            <tr><td><strong>Quick Action Cards</strong></td><td>Shortcuts to Portfolios, Morning Brief, Training Status, and Suggestions</td></tr>
        </tbody>
    </table>

    <div class="info-box tip">
        <strong>Tip:</strong> Start here to see if everything is running normally. If the "Last Pipeline Run" is old, something may be wrong.
    </div>

    <!-- Today -->
    <h3>üìÖ Today</h3>
    <p><strong>What it shows:</strong> Everything you need to know about today's trading situation.</p>
    
    <table>
        <thead>
            <tr><th>Section</th><th>What it means</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>System Status</strong></td><td>Is the database connection working? Green = OK</td></tr>
            <tr><td><strong>Portfolio Selector</strong></td><td>Switch between different portfolios</td></tr>
            <tr><td><strong>Risk Gate</strong></td><td>Are entries allowed? Shows <span class="badge badge-safe">SAFE</span>, <span class="badge badge-caution">CAUTION</span>, or <span class="badge badge-stopped">STOPPED</span></td></tr>
            <tr><td><strong>Recent Run Events</strong></td><td>What happened in the last pipeline run</td></tr>
            <tr><td><strong>Today's Insights</strong></td><td>Ranked list of trading candidates for today</td></tr>
            <tr><td><strong>Latest Brief</strong></td><td>The most recent morning brief (collapsible)</td></tr>
        </tbody>
    </table>

    <h4>Today's Insights explained:</h4>
    <table>
        <thead>
            <tr><th>Field</th><th>Meaning</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Symbol/Pattern</strong></td><td>Which stock and what pattern was detected</td></tr>
            <tr><td><strong>Maturity Score</strong></td><td>How confident we are in this pattern (0-100%)</td></tr>
            <tr><td><strong>Today Score</strong></td><td>How strong the signal is today</td></tr>
            <tr><td><strong>Why Shown</strong></td><td>The reason this candidate appears</td></tr>
        </tbody>
    </table>

    <!-- Portfolio -->
    <h3>üíº Portfolio</h3>
    <p><strong>What it shows:</strong> Detailed view of a trading portfolio's performance and current state.</p>

    <h4>List View (all portfolios)</h4>
    <table>
        <thead>
            <tr><th>Column</th><th>What it means</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Gate</strong></td><td>Risk status (<span class="badge badge-safe">SAFE</span> / <span class="badge badge-caution">CAUTION</span> / <span class="badge badge-stopped">STOPPED</span>)</td></tr>
            <tr><td><strong>Health</strong></td><td>Overall portfolio health indicator</td></tr>
            <tr><td><strong>Equity</strong></td><td>Current total value</td></tr>
            <tr><td><strong>Paid Out</strong></td><td>Money withdrawn/distributed</td></tr>
            <tr><td><strong>Active Episode</strong></td><td>Current trading period</td></tr>
            <tr><td><strong>Status</strong></td><td>ACTIVE, BUST, or STOPPED</td></tr>
        </tbody>
    </table>

    <h4>Header Metrics (Detail View)</h4>
    <table>
        <thead>
            <tr><th>Metric</th><th>What it means</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Starting Cash</strong></td><td>How much money the portfolio started with</td></tr>
            <tr><td><strong>Final Equity</strong></td><td>Current total value (cash + positions)</td></tr>
            <tr><td><strong>Total Return</strong></td><td>Percentage gain or loss</td></tr>
            <tr><td><strong>Max Drawdown</strong></td><td>Largest peak-to-trough decline (worst case)</td></tr>
            <tr><td><strong>Win Days</strong></td><td>Days with positive returns</td></tr>
            <tr><td><strong>Loss Days</strong></td><td>Days with negative returns</td></tr>
        </tbody>
    </table>

    <h4>Portfolio Charts</h4>
    <div class="card-grid">
        <div class="card">
            <h5>üìà Equity Chart</h5>
            <p>Portfolio value over time. Blue dot = current value. Red dashed line = bust threshold.</p>
        </div>
        <div class="card">
            <h5>üìâ Drawdown Chart</h5>
            <p>Current decline from peak. More negative = worse. Dotted line = warning threshold.</p>
        </div>
        <div class="card">
            <h5>üìä Trades per Day</h5>
            <p>Bar chart of trading activity over time.</p>
        </div>
        <div class="card">
            <h5>üö¶ Risk Regime</h5>
            <p>Color strip showing SAFE (green), CAUTION (yellow), STOPPED (red) over time.</p>
        </div>
    </div>

    <!-- Morning Brief -->
    <h3>‚òÄÔ∏è Morning Brief</h3>
    <p><strong>What it shows:</strong> A daily summary of opportunities, risks, and portfolio actions.</p>

    <table>
        <thead>
            <tr><th>Section</th><th>What it means</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Executive Summary</strong></td><td>High-level status: Are entries allowed? How many suggestions? Any executed trades?</td></tr>
            <tr><td><strong>Portfolio Actions</strong></td><td>Live state: open positions, trades this run, last simulation</td></tr>
            <tr><td><strong>Today's Proposals</strong></td><td>Suggested trades (NOT yet executed)</td></tr>
            <tr><td><strong>Risk & Guardrails</strong></td><td>Current risk state, profile thresholds, allowed actions</td></tr>
            <tr><td><strong>Changes Since Last Brief</strong></td><td>What changed: equity, return, drawdown, positions</td></tr>
        </tbody>
    </table>

    <div class="info-box warning">
        <strong>Staleness indicator:</strong><br>
        ‚Ä¢ <strong>CURRENT</strong> (green): Brief matches the latest pipeline run<br>
        ‚Ä¢ <strong>STALE</strong> (yellow): A newer pipeline run exists; brief may be outdated
    </div>

    <!-- Signals -->
    <h3>üì° Signals</h3>
    <p><strong>What it shows:</strong> A searchable list of all trading signals generated by the system.</p>

    <table>
        <thead>
            <tr><th>Column</th><th>What it means</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Symbol</strong></td><td>The stock/asset (e.g., AAPL, GOOGL)</td></tr>
            <tr><td><strong>Market</strong></td><td>Type of asset (STOCK, ETF, FX)</td></tr>
            <tr><td><strong>Pattern</strong></td><td>Which pattern detected this signal</td></tr>
            <tr><td><strong>Score</strong></td><td>Signal strength (higher = stronger)</td></tr>
            <tr><td><strong>Trust</strong></td><td><span class="badge badge-trusted">TRUSTED</span>, <span class="badge badge-watch">WATCH</span>, or <span class="badge badge-untrusted">UNTRUSTED</span></td></tr>
            <tr><td><strong>Action</strong></td><td>BUY or SELL</td></tr>
            <tr><td><strong>Eligible</strong></td><td>Can this signal be traded today?</td></tr>
        </tbody>
    </table>

    <!-- Market Timeline -->
    <h3>üìà Market Timeline</h3>
    <p><strong>What it shows:</strong> End-to-end view of what happened with each symbol ‚Äî from signals to proposals to trades.</p>

    <div class="card-grid">
        <div class="card">
            <h5>Symbol Grid</h5>
            <p>Each card shows a symbol with counts of signals, proposals, and trades.</p>
        </div>
        <div class="card">
            <h5>OHLC Chart</h5>
            <p>Price candlesticks with event overlays (signals, proposals, trades marked).</p>
        </div>
        <div class="card">
            <h5>Decision Narrative</h5>
            <p>AI-generated explanation of what happened with this symbol.</p>
        </div>
        <div class="card">
            <h5>Trust Summary</h5>
            <p>Trust levels by pattern for this symbol.</p>
        </div>
    </div>

    <!-- Suggestions -->
    <h3>üí° Suggestions</h3>
    <p><strong>What it shows:</strong> Ranked list of trading opportunities based on historical performance.</p>

    <table>
        <thead>
            <tr><th>Category</th><th>Meaning</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Strong Candidates</strong></td><td>Patterns with 10+ recommendations (more reliable)</td></tr>
            <tr><td><strong>Early Signals</strong></td><td>Patterns with 3-9 recommendations (still learning)</td></tr>
        </tbody>
    </table>

    <h4>For each suggestion:</h4>
    <table>
        <thead>
            <tr><th>Element</th><th>What it means</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Rank</strong></td><td>Overall ranking based on suggestion score</td></tr>
            <tr><td><strong>Suggestion Score</strong></td><td>Combined score (higher = better opportunity)</td></tr>
            <tr><td><strong>Maturity Stage</strong></td><td>INSUFFICIENT ‚Üí WARMING_UP ‚Üí LEARNING ‚Üí CONFIDENT</td></tr>
            <tr><td><strong>Horizon Strip</strong></td><td>Performance at 1, 3, 5, 10, 20 bars forward</td></tr>
        </tbody>
    </table>

    <!-- Training Status -->
    <h3>üéì Training Status</h3>
    <p><strong>What it shows:</strong> How well the system has learned each pattern for each symbol.</p>

    <table>
        <thead>
            <tr><th>Column</th><th>What it means</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Maturity</strong></td><td>Learning stage and confidence score</td></tr>
            <tr><td><strong>Sample Size</strong></td><td>How many times this pattern was observed</td></tr>
            <tr><td><strong>Coverage</strong></td><td>Percentage of observations that have been evaluated</td></tr>
            <tr><td><strong>Avg Outcomes</strong></td><td>Average returns at each horizon (H1, H3, H5, H10, H20)</td></tr>
        </tbody>
    </table>

    <h4>Maturity Stages:</h4>
    <table>
        <thead>
            <tr><th>Stage</th><th>Meaning</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>INSUFFICIENT</strong></td><td>Not enough data to draw conclusions</td></tr>
            <tr><td><strong>WARMING_UP</strong></td><td>Starting to gather data</td></tr>
            <tr><td><strong>LEARNING</strong></td><td>Building confidence</td></tr>
            <tr><td><strong>CONFIDENT</strong></td><td>Enough data for reliable predictions</td></tr>
        </tbody>
    </table>

    <!-- Audit Viewer -->
    <h3>üîç Audit Viewer (Run Explorer)</h3>
    <p><strong>What it shows:</strong> Detailed history of all pipeline runs, including errors.</p>

    <div class="card-grid">
        <div class="card">
            <h5>Run List</h5>
            <p>All pipeline runs with status, duration, and timestamp. Filter by status or date range.</p>
        </div>
        <div class="card">
            <h5>Run Narrative</h5>
            <p>Plain English: what happened, why, impact, next steps.</p>
        </div>
        <div class="card">
            <h5>Error Panel</h5>
            <p>If failed: error message, SQL query ID, debug SQL to investigate.</p>
        </div>
        <div class="card">
            <h5>Step Timeline</h5>
            <p>Visual flow of each step with success/failure status.</p>
        </div>
    </div>
</section>

<!-- Section 3: Backend -->
<section id="backend">
    <h2>3. How the Backend Works</h2>

    <h3>3.1 Pipeline Overview</h3>
    <p>The system runs a daily pipeline that processes data through these steps:</p>

    <div class="flow-diagram">
        <div class="flow-step"><span class="flow-number">1</span> <strong>INGESTION</strong> ‚Äî Fetch market data from API</div>
        <div class="flow-step"><span class="flow-number">2</span> <strong>RETURNS</strong> ‚Äî Calculate price returns</div>
        <div class="flow-step"><span class="flow-number">3</span> <strong>RECOMMENDATIONS</strong> ‚Äî Generate trading signals</div>
        <div class="flow-step"><span class="flow-number">4</span> <strong>EVALUATION</strong> ‚Äî Measure signal quality</div>
        <div class="flow-step"><span class="flow-number">5</span> <strong>SIMULATION</strong> ‚Äî Run portfolio paper trading</div>
        <div class="flow-step"><span class="flow-number">6</span> <strong>PROPOSALS</strong> ‚Äî Create trade suggestions</div>
        <div class="flow-step"><span class="flow-number">7</span> <strong>EXECUTION</strong> ‚Äî Execute approved trades (paper)</div>
        <div class="flow-step"><span class="flow-number">8</span> <strong>MORNING BRIEF</strong> ‚Äî Generate daily summary</div>
    </div>

    <h3>3.2 Step-by-Step Breakdown</h3>

    <h4>Step 1: Ingestion</h4>
    <p><strong>What happens:</strong> Fetches OHLC (Open, High, Low, Close) price data from AlphaVantage API.</p>
    <table>
        <tr><td><strong>Table affected:</strong></td><td><code>MARKET_BARS</code> ‚Äî Stores all price data</td></tr>
        <tr><td><strong>Key behavior:</strong></td><td>Checks if new data exists since last run. If rate-limited, may skip downstream steps.</td></tr>
    </table>

    <h4>Step 2: Returns Refresh</h4>
    <p><strong>What happens:</strong> Calculates daily returns from price data.</p>
    <table>
        <tr><td><strong>View affected:</strong></td><td><code>MARKET_RETURNS</code> ‚Äî Shows percentage changes</td></tr>
        <tr><td><strong>Calculations:</strong></td><td>Simple returns: (today - yesterday) / yesterday<br>Log returns: ln(today / yesterday)</td></tr>
    </table>

    <h4>Step 3: Generate Recommendations</h4>
    <p><strong>What happens:</strong> Runs pattern detection algorithms to find trading signals.</p>
    <table>
        <tr><td><strong>Table affected:</strong></td><td><code>RECOMMENDATION_LOG</code> ‚Äî Stores all detected signals</td></tr>
        <tr><td><strong>Markets scanned:</strong></td><td>STOCK, ETF, FX</td></tr>
    </table>

    <h4>Step 4: Evaluate Recommendations</h4>
    <p><strong>What happens:</strong> Measures how well past signals performed.</p>
    <table>
        <tr><td><strong>Table affected:</strong></td><td><code>RECOMMENDATION_OUTCOMES</code> ‚Äî Stores evaluation results</td></tr>
        <tr><td><strong>Horizons measured:</strong></td><td>1, 3, 5, 10, and 20 bars forward</td></tr>
    </table>

    <h4>Step 5: Portfolio Simulation</h4>
    <p><strong>What happens:</strong> Runs paper trading simulation for each active portfolio.</p>
    <table>
        <tr><td><strong>Tables affected:</strong></td><td><code>PORTFOLIO_DAILY</code>, <code>PORTFOLIO_TRADES</code>, <code>PORTFOLIO_POSITIONS</code></td></tr>
        <tr><td><strong>Key behavior:</strong></td><td>Uses trusted signals, applies risk rules, updates portfolio metrics</td></tr>
    </table>

    <h4>Step 6: Trade Proposals</h4>
    <p><strong>What happens:</strong> Creates trade suggestions from eligible signals.</p>
    <table>
        <tr><td><strong>Table affected:</strong></td><td><code>ORDER_PROPOSALS</code> ‚Äî Suggested trades</td></tr>
        <tr><td><strong>Filters applied:</strong></td><td>Trusted patterns, within limits, not duplicating positions</td></tr>
    </table>

    <h4>Step 7: Execution</h4>
    <p><strong>What happens:</strong> Validates and executes approved proposals.</p>
    <table>
        <tr><td><strong>Tables affected:</strong></td><td><code>ORDER_PROPOSALS</code> (status update), <code>PORTFOLIO_TRADES</code>, <code>PORTFOLIO_POSITIONS</code></td></tr>
        <tr><td><strong>Checks:</strong></td><td>Risk gate status, position limits</td></tr>
    </table>

    <h4>Step 8: Morning Brief</h4>
    <p><strong>What happens:</strong> Generates a JSON summary of the day.</p>
    <table>
        <tr><td><strong>Table affected:</strong></td><td><code>MORNING_BRIEF</code> ‚Äî Stores the brief</td></tr>
        <tr><td><strong>Contents:</strong></td><td>Opportunities, risks, portfolio state, deltas from yesterday</td></tr>
    </table>

    <h3>3.3 Data Flow</h3>

    <div class="data-flow">
        <div class="data-flow-item">AlphaVantage API</div>
        <div class="data-flow-arrow">‚Üì</div>
        <div class="data-flow-item primary">MARKET_BARS (raw prices)</div>
        <div class="data-flow-arrow">‚Üì</div>
        <div class="data-flow-item">MARKET_RETURNS (calculated returns)</div>
        <div class="data-flow-arrow">‚Üì</div>
        <div class="data-flow-item primary">RECOMMENDATION_LOG (signals)</div>
        <div class="data-flow-arrow">‚Üì</div>
        <div class="data-flow-item">RECOMMENDATION_OUTCOMES (evaluated)</div>
        <div class="data-flow-arrow">‚Üì</div>
        <div class="data-flow-item">V_TRUSTED_SIGNALS (trust classification)</div>
        <div class="data-flow-arrow">‚Üì</div>
        <div class="data-flow-item primary">PORTFOLIO_DAILY / TRADES / POSITIONS</div>
        <div class="data-flow-arrow">‚Üì</div>
        <div class="data-flow-item">ORDER_PROPOSALS (suggestions)</div>
        <div class="data-flow-arrow">‚Üì</div>
        <div class="data-flow-item primary">MORNING_BRIEF (final output)</div>
    </div>
</section>

<!-- Section 4: Key Concepts -->
<section id="concepts">
    <h2>4. Key Concepts</h2>

    <h3>4.1 Episodes</h3>
    <p><strong>What is an episode?</strong> A lifecycle period for a portfolio. Think of it as a "trading season" with a clear start and end.</p>

    <table>
        <thead>
            <tr><th>State</th><th>Meaning</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>ACTIVE</strong></td><td>Currently trading</td></tr>
            <tr><td><strong>ENDED</strong></td><td>Finished normally</td></tr>
            <tr><td><strong>CRYSTALLIZED</strong></td><td>Profit target hit, gains locked in</td></tr>
            <tr><td><strong>STOPPED</strong></td><td>Risk limits breached</td></tr>
            <tr><td><strong>BUST</strong></td><td>Lost too much, trading halted</td></tr>
        </tbody>
    </table>

    <div class="info-box tip">
        <strong>Why episodes matter:</strong> All portfolio data is scoped to the current episode. When you "reset" a portfolio, you end the current episode and start a new one. Historical episodes are preserved for analysis.
    </div>

    <h3>4.2 Run IDs</h3>
    <p><strong>What is a Run ID?</strong> A unique identifier that tracks every pipeline execution and simulation run.</p>

    <table>
        <thead>
            <tr><th>Type</th><th>Format</th><th>Used for</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Pipeline Run ID</strong></td><td>UUID (e.g., <code>05a39214-cc22-...</code>)</td><td>Tracking the overall pipeline</td></tr>
            <tr><td><strong>Simulation Run ID</strong></td><td>UUID</td><td>Per-portfolio simulation</td></tr>
        </tbody>
    </table>

    <h3>4.3 Risk Gates</h3>
    <p><strong>What is a risk gate?</strong> A safety mechanism that can block new trades when risk thresholds are breached.</p>

    <table>
        <thead>
            <tr><th>State</th><th>Meaning</th></tr>
        </thead>
        <tbody>
            <tr><td><span class="badge badge-safe">SAFE</span></td><td>Normal operation, entries allowed</td></tr>
            <tr><td><span class="badge badge-caution">CAUTION</span></td><td>Warning level, monitor closely</td></tr>
            <tr><td><span class="badge badge-stopped">STOPPED</span></td><td>Entries blocked, only exits allowed</td></tr>
        </tbody>
    </table>

    <h4>What triggers STOPPED?</h4>
    <ul>
        <li><strong>Drawdown stop:</strong> Portfolio dropped too much from peak (e.g., 10%)</li>
        <li><strong>Bust threshold:</strong> Portfolio value fell below bust level (e.g., 60% of starting cash)</li>
    </ul>

    <h4>Profile thresholds:</h4>
    <table>
        <thead>
            <tr><th>Threshold</th><th>Meaning</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Drawdown Stop %</strong></td><td>Max allowed decline from peak (e.g., 10%)</td></tr>
            <tr><td><strong>Bust Equity %</strong></td><td>Minimum value before bust (e.g., 60%)</td></tr>
            <tr><td><strong>Max Positions</strong></td><td>Maximum number of holdings</td></tr>
            <tr><td><strong>Max Position %</strong></td><td>Maximum size of any single position</td></tr>
        </tbody>
    </table>

    <h3>4.4 Trust Levels</h3>
    <p><strong>What is trust?</strong> A classification of how reliable a pattern is, based on historical performance.</p>

    <table>
        <thead>
            <tr><th>Level</th><th>Meaning</th><th>Threshold</th></tr>
        </thead>
        <tbody>
            <tr><td><span class="badge badge-trusted">TRUSTED</span></td><td>Reliable, can trade</td><td>30+ successes, 80%+ coverage, positive returns</td></tr>
            <tr><td><span class="badge badge-watch">WATCH</span></td><td>Promising, needs more data</td><td>Some successes, still monitoring</td></tr>
            <tr><td><span class="badge badge-untrusted">UNTRUSTED</span></td><td>Not reliable, avoid</td><td>Negative returns or insufficient data</td></tr>
        </tbody>
    </table>

    <div class="info-box important">
        <strong>Important:</strong> Only <span class="badge badge-trusted">TRUSTED</span> patterns are used for actual trade proposals. WATCH patterns are monitored but not traded.
    </div>

    <h3>4.5 Proposals vs Trades</h3>

    <table>
        <thead>
            <tr><th>Concept</th><th>What it is</th><th>Where to see it</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Signal</strong></td><td>A pattern detection (raw opportunity)</td><td>Signals page</td></tr>
            <tr><td><strong>Proposal</strong></td><td>A suggested trade (passed filters)</td><td>Morning Brief</td></tr>
            <tr><td><strong>Trade</strong></td><td>An executed transaction (paper)</td><td>Portfolio page</td></tr>
        </tbody>
    </table>

    <p><strong>The journey:</strong></p>
    <pre>SIGNAL ‚Üí [Trust check] ‚Üí [Eligibility check] ‚Üí PROPOSAL ‚Üí [Risk check] ‚Üí TRADE</pre>

    <h4>Status progression:</h4>
    <table>
        <thead>
            <tr><th>Status</th><th>Meaning</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>PROPOSED</strong></td><td>Suggestion created, awaiting validation</td></tr>
            <tr><td><strong>APPROVED</strong></td><td>Passed all checks, ready to execute</td></tr>
            <tr><td><strong>REJECTED</strong></td><td>Failed validation (risk gate, limits, etc.)</td></tr>
            <tr><td><strong>EXECUTED</strong></td><td>Successfully traded (paper)</td></tr>
        </tbody>
    </table>
</section>

<!-- Section 5: Troubleshooting -->
<section id="troubleshooting">
    <h2>5. Troubleshooting</h2>

    <h3>"STALE" brief showing</h3>
    <table>
        <tr><td><strong>Symptom:</strong></td><td>Morning Brief shows "STALE" badge</td></tr>
        <tr><td><strong>Cause:</strong></td><td>A newer pipeline run completed but the brief is from an older run</td></tr>
        <tr><td><strong>Solution:</strong></td><td>Check Audit Viewer for recent pipeline runs. If a run completed successfully, the brief should refresh.</td></tr>
    </table>

    <h3>No trades happening</h3>
    <table>
        <thead>
            <tr><th>Possible Cause</th><th>How to check</th></tr>
        </thead>
        <tbody>
            <tr><td>Risk gate STOPPED</td><td>Check Portfolio page ‚Üí Risk Gate card</td></tr>
            <tr><td>No trusted patterns</td><td>Check Training Status for maturity</td></tr>
            <tr><td>No new market data</td><td>Check if pipeline shows "NO_NEW_BARS"</td></tr>
            <tr><td>Position limits full</td><td>Check Open Positions vs Max Positions</td></tr>
        </tbody>
    </table>

    <h3>Wrong metrics (drawdown, win/loss days)</h3>
    <table>
        <tr><td><strong>Symptom:</strong></td><td>Metrics don't match expected values</td></tr>
        <tr><td><strong>Possible cause:</strong></td><td>Historical data from before episode reset</td></tr>
        <tr><td><strong>Solution:</strong></td><td>Run the episode cleanup migration, then re-run the pipeline</td></tr>
    </table>

    <h3>Pipeline shows "SUCCESS_WITH_SKIPS"</h3>
    <table>
        <tr><td><strong>Meaning:</strong></td><td>Some steps were skipped, usually because no new market data or rate limit hit</td></tr>
        <tr><td><strong>Is this a problem?</strong></td><td>Usually not. This is normal when there's no new data to process.</td></tr>
    </table>
</section>

<!-- Section 6: Glossary -->
<section id="glossary">
    <h2>6. Glossary</h2>

    <table>
        <thead>
            <tr><th>Term</th><th>Definition</th></tr>
        </thead>
        <tbody>
            <tr><td><strong>Bar</strong></td><td>A single OHLC price data point (Open, High, Low, Close)</td></tr>
            <tr><td><strong>Bust</strong></td><td>When portfolio value drops below the bust threshold</td></tr>
            <tr><td><strong>Crystallize</strong></td><td>Lock in gains when profit target is hit</td></tr>
            <tr><td><strong>Drawdown</strong></td><td>Decline from peak equity (expressed as %)</td></tr>
            <tr><td><strong>Episode</strong></td><td>A portfolio lifecycle period with defined start/end</td></tr>
            <tr><td><strong>Equity</strong></td><td>Total portfolio value (cash + positions)</td></tr>
            <tr><td><strong>Hit Rate</strong></td><td>Percentage of signals that went in the predicted direction</td></tr>
            <tr><td><strong>Horizon</strong></td><td>Forward time period for evaluation (1, 3, 5, 10, 20 bars)</td></tr>
            <tr><td><strong>Idempotent</strong></td><td>Can be run multiple times without creating duplicates</td></tr>
            <tr><td><strong>Maturity</strong></td><td>How well the system has learned a pattern</td></tr>
            <tr><td><strong>OHLC</strong></td><td>Open, High, Low, Close ‚Äî standard price bar format</td></tr>
            <tr><td><strong>Pattern</strong></td><td>A price behavior that signals a trading opportunity</td></tr>
            <tr><td><strong>Pipeline</strong></td><td>The automated sequence of data processing steps</td></tr>
            <tr><td><strong>Position</strong></td><td>A holding in an asset (shares owned)</td></tr>
            <tr><td><strong>Proposal</strong></td><td>A suggested trade that passed initial filters</td></tr>
            <tr><td><strong>Risk Gate</strong></td><td>Safety mechanism controlling trade entries</td></tr>
            <tr><td><strong>Run ID</strong></td><td>Unique identifier for a pipeline or simulation execution</td></tr>
            <tr><td><strong>Signal</strong></td><td>A detected trading opportunity from pattern matching</td></tr>
            <tr><td><strong>Simulation</strong></td><td>Paper trading that doesn't use real money</td></tr>
            <tr><td><strong>Trust</strong></td><td>Reliability classification of a pattern</td></tr>
        </tbody>
    </table>
</section>

</div>

<footer>
    <p>MIP User Guide ‚Äî Last updated: February 2026</p>
</footer>

</body>
</html>
